======================================================================
Simulation of Bi214-Po214 decays in gas and SimRC reconstruction
======================================================================

:author: F.Mauger
:date: 2022-06-10

**Summary**

   This note illustrates how to generate a sample of simulated events with Bi214-Po214 decays
   from the surface of field wires in the SuperNEMO tracking chamber then to apply the SimRC
   module to inhibit some part of the tracker at reconstruction.
   
 
       
.. contents:
 


Prepare simulation
====================================

* Bayeux : 3.5.3
* Falaise : 4.1.0 (alpha) with preliminary SimRC module

Variant profile
---------------

.. code:: shell

   $ flsimulate-configure \
	  --no-gui \
	  -s "geometry:layout/if_basic/source_layout=RealisticFlat" \
	  -s "vertexes:generator=field_wire_surface" \
	  -s "primary_events:generator=Bi214_Po214" \
	  -s "simulation:output_profile=tracker_details" \
          -o snemo_mc_bipo214-field_wires.profile
..

Seeds
----------

Generation of a set of seeds for ``flsimulate``: 

* ``EG`` : **E** vent **G** eneration
* ``VG`` : **V** ertex **G** eneration
* ``MGR`` :  simulation **M** ana **G** er **R** (Geant4 engine)
* ``SHPF`` : **S** tep **H** it **P** rocessor **F** actory (post-processing of truth hits)
  
#. Manual method :

   .. code:: shell

      $ echo "{EG=191715403; MGR=853192215; SHPF=782653426; VG=237737954}" > snemo_mc_bipo214-field_wires.seeds
   ..

#. Automated method :
   
   .. code:: shell

      $ bxg4_seeds -n 1 -d ./tmpSeeds
      $ mv ./tmpSeeds/seeds_0.conf ./snemo_mc_bipo214-field_wires.seeds
      $ rm -fr ./tmpSeeds/
      $ cat snemo_mc_bipo214-field_wires.seeds
      {EG=191715403; MGR=853192215; SHPF=782653426; VG=237737954}
   ..
   

Main configuration file
====================================

``snemo_mc_bipo214-field_wires.conf``

.. code::

   #@description Main flsimulate configuration script
   #@key_label  "name"
   #@meta_label "type"

   [name="flsimulate" type="flsimulate::section"]
   numberOfEvents : integer = 10000

   [name="flsimulate.simulation" type="flsimulate::section"]
   rngSeedFile : string as path = "snemo_mc_bipo214-field_wires.seeds"
   
   [name="flsimulate.variantService" type="flsimulate::section"]
   profile : string as path = "snemo_mc_bipo214-field_wires.profile"   
..

Run simulation
====================================

.. code:: shell
	  
   $ flsimulate -c snemo_mc_bipo214-field_wires.conf -o snemo_mc_bipo214-field_wires.brio
   $ ls -l snemo_mc_bipo214-field_wires.brio
   -rw-r--r-- 1 nemoprod nemoprod 476473962 juin  10 08:13 snemo_mc_bipo214-field_wires.brio
..

**Note:**

 Here  the ``tracker_details``  profile has been  selected as
 the level  of simulation output in  the variant profile, the  size of
 the  MC file  is thus  enormous.  This  is because  *truth* hits  are
 preserved and  stored at the post-processing  step in ``flsimulate``.
 The hit  collection named ``__visu.tracks``  is filled with  hundreds of
 basic step hits generated by the Geant4 engine. In return, it is possible to visualize
 *true* MC tracks in the visualization program (see below).

.. raw:: pdf

   PageBreak
..


Visualization
====================================

Run Falaise event browser:

.. code:: shell
	  
   $ flvisualize -f snemo_mc_bipo214-field_wires.profile -i snemo_mc_bipo214-field_wires.brio 
..

Some examples of simulated Bi-Po events:

===================================================== =====================================================
                                                                   
  .. image:: images/event_bipo214-field_wires-1.png    .. image:: images/event_bipo214-field_wires-2.png
  
===================================================== =====================================================

===================================================== =====================================================
                                                                    
  .. image:: images/event_bipo214-field_wires-3.png    .. image:: images/event_bipo214-field_wires-4.png
  
===================================================== =====================================================
                                                                   


Reconstruction
================

The variant profile used to run the simulation is defined:

.. code:: shell

   ###################################################################
   [name="flreconstruct.variantService" type="flreconstruct::section"]
   profile : string as path = "snemo_mc_bipo214-field_wires.profile"
..

	 

SimrRC module
---------------

We need a list of dead/off cells to feed the *tracker cell status* service:

* ``area3_cells_dead.csv`` : list of deal cells in the Area #3 of the tracker (rows 42 to 55)

  Format:
  
  .. code::
     
     # Geom ID       ; Period                                    ; Status flags
     [1204:0.1.8.47] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; dead
     [1204:0.1.8.48] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; dead
     [1204:0.1.3.49] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; dead
     [1204:0.1.2.48] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; dead
     [1204:0.1.1.50] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; dead
  ..
  
  
* ``area3_cells_off.csv`` : all other cells are set off (rows 0-41 and 56-112)

  Format:
  
  .. code::
     
     # Geom ID        ; Period                                    ; Status flags
     [1204:0.0.0.0]   ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; off
     [1204:0.0.0.1]   ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; off
     [1204:0.0.0.2]   ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; off
     [1204:0.0.0.3]   ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; off
     ...
     [1204:0.1.8.112] ; [2022-01-01 00:00:00/2028-01-01 00:00:00) ; off
  ..
  
The  *tracker cell status* service is configured through 
``tracker_cell_status_service.conf`` : 

.. code:: shell
	  
   #@description The SuperNEMO tracker cell status service
   #@key_label   "name"
   #@meta_label  "type"

   [name="trackerCellStatus" type="snemo::tracker_cell_status_service"]
   geometry_label  : string = "geometry"
   mode            : string = "files"
   files.cell_maps : string[2] as path = "area3_cells_dead.csv" "area3_cells_off.csv"
..


The service manager is configured through ``services.conf`` with two services: 

.. code:: shell
	  
   #@configuration SuperNEMO reconstruction service manager
   name        : string = "flReconstructServices"
   description : string = "SuperNEMO Demonstrator Service manager for reconstruction"
   services.configuration_files : string[2] as path = \
     "@falaise:snemo/demonstrator/geometry/GeometryService.conf" \
     "tracker_cell_status_service.conf"
..
   
The ``flreconstruct`` pipeline, including the SimRC module, is configured through
``simrc.conf`` where the SimRC module uses the following configuration:


.. code:: shell
	  
   #####################################################
   [name="SimRC" type="snemo::simulation::simrc_module"]
   #@config A module which applies 'Running Conditions' to idealized truth MC events
   logging.priority : string = "debug"
   # EH_label         : string = "EH"
   # SD_label         : string = "SD"

   # Step 1: add a decay timestamp in each event header, using the default ideal 30-months long run
   # and a constant activity model:

   # Activate the event timestamping driver:
   timestamp_event : boolean = true
       # We must timestamp 10000 input events generated by flsimulate
       event_timestamper.number_of_events : integer = 10000

   # Step 2: use the decay timestamp found in the event header, and tag truth tracker hits
   # with a special status (dead, off...) to be taken into account at digitization step
   # (some tracker calibrated hits won't be generated at all, or will be incomplete)

   # Activate the tracker cell status tagging driver:
   tag_tracker_cell : boolean = true
     # Specific configuration of the tracker cell tagger:
     tracker_cell_tagger.debug : boolean = false
    
   # Do not activate the calorimeter OM status tagging driver:
   tag_calorimeter_om : boolean = false
   
..

The Falaise SimRC plugin library must be loaded at startup:

.. code:: shell

   ############################################################
   [name="flreconstruct.plugins" type="flreconstruct::section"]
   plugins : string[7] = \
	  "Falaise_SimRC" \
	  ...
   ..
	  

Other reconstruction modules
------------------------------

The ``flreconstruct`` pipeline is built as usual with various modules chained agter the SimRC module.


Reconstruction with tracker RC
=========================================

Run ``flreconstruct`` with :

.. code:: shell

  $ flreconstruct \
	  -V debug \
	  -p simrc.conf \
	  -i snemo_mc_bipo214-field_wires.brio \
	  -o snemo_mc_bipo214-field_wires-rec.brio 
  ..


.. raw:: pdf

   PageBreak
..

 

Visualization
====================================

Run Falaise event browser:

.. code:: shell
	  
   $ flvisualize -f snemo_mc_bipo214-field_wires.profile -i snemo_mc_bipo214-field_wires-rec.brio 
..
 
Example of  a reconstructed  event with truth  hits not  digitized nor
calibrated because they fall out of the *active* region og the tracker
(rows 42-55) :

* Left : SD *truth* hits are visible above the row #55 (magenta)
* Right : Only the tracker  hits within the active interval of  rows are digitized
  and calibrated  and finally used  by the clustering algorithm.
  A  blue *delayed* cluster has been identified,  but here the track of the prompt electron
  (red hits) was not identified as a prompt cluster.

  
============================================================ =============================================================
                                                                   
 .. image:: images/event_bipo214-field_wires-reco-1bis.png    .. image:: images/event_bipo214-field_wires-reco-2.png
  
============================================================ =============================================================


Quick test
==========

.. code::

   $ flsimulate-configure \
	  --no-gui \
	  -s "geometry:layout/if_basic/source_layout=RealisticFlat" \
	  -s "vertexes:generator=field_wire_surface" \
	  -s "primary_events:generator=Bi214_Po214" \
          -o simu.profile
   $ echo "{EG=1; MGR=2; SHPF=3; VG=4}" > simu.seeds
   $ flsimulate -c simu.conf -o simu.brio
   $ flreconstruct -p reco.conf -i simu.brio -o reco.brio 
..

Extract from the *dump* module :

.. code::
   
   Event record: 
   |-- Bank 'CD' : "snemo::datamodel::calibrated_data"
   |   |-- CalorimeterHits[1]:
   |   |   `-- (Id : 0, GID : [1302:0.1.9.4.*], Energy : 770.168 keV, Time : 2.56591 ns)
   |   `-- TrackerHits[13]:
   |       |-- (Id : 0, GID : [1204:0.1.3.46], Type : delayed [time=18.989553 us])
   |       |-- (Id : 1, GID : [1204:0.1.2.46], Type : delayed [time=19.028453 us])
   |       |-- (Id : 2, GID : [1204:0.1.1.46], Type : delayed [time=18.781432 us])
   |       |-- (Id : 3, GID : [1204:0.1.0.46], Type : delayed [time=18.678961 us])
   |       |-- (Id : 4, GID : [1204:0.1.4.46], Type : prompt)
   |       |-- (Id : 5, GID : [1204:0.1.5.47], Type : prompt)
   |       |-- (Id : 6, GID : [1204:0.1.5.48], Type : prompt)
   |       |-- (Id : 7, GID : [1204:0.1.6.48], Type : prompt)
   |       |-- (Id : 8, GID : [1204:0.1.6.49], Type : prompt)
   |       |-- (Id : 9, GID : [1204:0.1.7.49], Type : prompt)
   |       |-- (Id : 10, GID : [1204:0.1.7.50], Type : prompt)
   |       |-- (Id : 11, GID : [1204:0.1.8.51], Type : prompt)
   |       `-- (Id : 12, GID : [1204:0.1.8.52], Type : prompt)
   |-- Bank 'EH' : "snemo::datamodel::event_header"
   |   |-- Id : 
   |   |   |-- Run number   : -2
   |   |   `-- Event number : 35
   |   |-- Timestamp : none
   |   |-- MC run ID : 0
   |   |-- MC timestamp : 2023-Jan-04 05:42:08.640000
   |   |-- Properties : 
   |   |   `-- <no property>
   |   `-- Generation : simulated
   :
..

.. end

   
